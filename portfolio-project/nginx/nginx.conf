server {
    # 1. 포트 설정: Cloudflare Tunnel이 내부적으로 80 포트로 통신하므로 443/SSL 불필요
    listen 80; 
    server_name portfolio.ywsung.ai.kr;

    # =================================================================
    # [Real IP 복원 설정] - 핵심 추가 사항
    # =================================================================
    # Docker 네트워크 대역(172.16.0.0/12)을 신뢰할 수 있는 프록시로 지정합니다.
    # Nginx 앞단의 프록시(Cloudflare Tunnel/Docker Gateway)가 보내주는 헤더를 믿습니다.
    set_real_ip_from 172.16.0.0/12; 
    
    # 실제 클라이언트 IP가 담겨있는 헤더를 지정합니다.
    real_ip_header X-Forwarded-For;
    
    # 여러 프록시를 거칠 경우, 신뢰할 수 없는 마지막 IP를 사용자로 식별합니다.
    real_ip_recursive on;

    # =================================================================
    # [로그 설정]
    # =================================================================
    # 이제 access.log에 172.18.0.5가 아닌 실제 사용자의 IP가 기록됩니다.
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # =================================================================
    # [보안 강화] 기존 차단 규칙 유지
    # =================================================================

    # 숨김 파일 차단 (.env, .git 등)
    location ~ /\.(?!well-known).* {
        deny all;
        access_log off;
        return 404;
    }

    # 공격 경로 및 불필요한 메서드 차단
    location ~* ^/(cgi-bin|owa|actuator|autodiscover|phpmyadmin|wp-admin|wp-content|wp-includes|manager)/ {
        deny all;
        access_log off;
        return 404;
    }

    # 불필요한 확장자 차단
    location ~* \.(php|pl|py|jsp|asp|aspx|exe|sh)$ {
        deny all;
        access_log off;
        return 404;
    }

    # 허용되지 않은 HTTP 메서드 차단
    if ($request_method !~ ^(GET|POST|HEAD|PUT|DELETE|OPTIONS|PATCH)$) {
        return 405;
    }

    # =================================================================
    # [애플리케이션 로직]
    # =================================================================

    # 1. 프론트엔드 애플리케이션 (Vue.js SPA)
    location / {
        proxy_pass http://frontend:80;
        
        # [중요] 터널을 타면 로컬호스트 통신이 되므로 Host 헤더를 명시
        proxy_set_header Host $host;
        
        # [IP 전달] set_real_ip_from 덕분에 $remote_addr에 이제 '진짜 IP'가 들어있습니다.
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # [프로토콜] 앱은 HTTP로 받지만, 실제 사용자는 HTTPS로 접속했음을 알림
        proxy_set_header X-Forwarded-Proto https; 

        # WebSocket 지원
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 캐싱 및 압축
        expires 1h;
        add_header Cache-Control "public, no-transform";
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    }

    # 2. 백엔드 API
    location /api/ {
        proxy_pass http://backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https; # 백엔드에 HTTPS임을 강제

        client_max_body_size 10M;
    }

    # 3. 정적 파일
    location /static/ {
        proxy_pass http://backend:8000;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        expires 30d;
        add_header Cache-Control "public, no-transform, immutable";
    }
    
    # 4. SEO 파일들
    location = /robots.txt {
        proxy_pass http://frontend:80;
        expires 7d;
        add_header Cache-Control "public, no-transform";
    }
    
    location = /sitemap.xml {
        proxy_pass http://backend:8000/api/v1/sitemap.xml;
        expires 1d;
        add_header Cache-Control "public, no-transform";
        add_header Content-Type "application/xml";
    }
}
